name: Build Make Me Admin

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore MakeMeAdmin.sln

    - name: Add WiX Toolset to PATH
      run: |
        $wixPath = "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin"
        if (Test-Path $wixPath) {
          echo $wixPath >> $env:GITHUB_PATH
        } else {
          choco install wixtoolset -y --no-progress
          echo "${env:ProgramFiles(x86)}\WiX Toolset v3.14\bin" >> $env:GITHUB_PATH
        }

    - name: Build all projects except Setup
      run: |
        # Build each project explicitly to avoid Setup being triggered prematurely
        $projects = @(
          "Enumerations\Enumerations.csproj",
          "Settings\Settings.csproj",
          "LsaLogonSessions\LsaLogonSessions.csproj",
          "Logging\Logging.csproj",
          "UserList\UserList.csproj",
          "ProcessCommunication\ProcessCommunication.csproj",
          "UserRequestApp\LocalUI.csproj",
          "Service\Service.csproj",
          "RemoteUI\RemoteUI.csproj",
          "WiXCustomAction\WiXCustomAction.csproj",
          "TestCode\TestCode.csproj"
        )
        foreach ($proj in $projects) {
          Write-Host "Building $proj..."
          msbuild $proj /p:Configuration=${{ matrix.configuration }} /p:Platform="${{ matrix.platform }}" /t:Build
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        }

    - name: Build WiX Setup project
      run: |
        msbuild Setup\Setup.wixproj /p:Configuration=${{ matrix.configuration }} /p:Platform="${{ matrix.platform }}" /p:SolutionName=MakeMeAdmin /t:Build

    - name: Collect and rename MSI files
      run: |
        $outputDir = "Setup\bin\${{ matrix.configuration }} ${{ matrix.platform }}"
        $collectDir = "collected-msi"
        New-Item -ItemType Directory -Force -Path $collectDir

        # Find all MSI files in culture subdirectories
        $cultures = @("da", "de", "en-us", "fr")
        foreach ($culture in $cultures) {
          $culturePath = Join-Path $outputDir $culture
          if (Test-Path $culturePath) {
            $msiFiles = Get-ChildItem -Path $culturePath -Filter "*.msi"
            foreach ($msi in $msiFiles) {
              # Extract version from filename (e.g., MakeMeAdmin-2.4.1-x64.msi -> 2.4.1)
              if ($msi.Name -match "MakeMeAdmin-(\d+\.\d+\.\d+)-") {
                $version = $matches[1]
                $newName = "MakeMeAdmin-$version-${{ matrix.platform }}-$culture.msi"
                Copy-Item $msi.FullName -Destination (Join-Path $collectDir $newName)
                Write-Host "Collected: $newName"
              }
            }
          }
        }

        # List collected files
        Get-ChildItem $collectDir

    - name: Upload MSI Installers
      uses: actions/upload-artifact@v4
      with:
        name: MakeMeAdmin-MSI-${{ matrix.platform }}
        path: collected-msi/*.msi
        if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all MSI artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: MakeMeAdmin-MSI-*
        path: release-files
        merge-multiple: true

    - name: Generate SHA256 checksums
      run: |
        cd release-files
        sha256sum *.msi > sha256sum.txt
        cat sha256sum.txt

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-files/*.msi
          release-files/sha256sum.txt
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
